PALLETIZER -*- mode: org -*-
#+STARTUP: showall
#+TODO: TODO TEST VERSION | DONE CANCELED

** DONE Optimizer:
*** DONE Path Triangulation.
*** DONE Return paths.
*** DONE Level Paths.
*** DONE Remove Point Duplicates.
*** DONE Extend vertical paths.
*** DONE Add Action Coordinates for pick and drop.
*** DONE Plugin to server.
*** DONE Make path avoid both top and bottom of box.
*** DONE Pick location lip height height: Vivian: "just use box height."
*** DONE Handle errors / ensure no errors.
*** DONE Use Line class.
*** DONE Top and bottom of box constraint.

** TODO Machine Configuration:
*** TODO Default extra drive for V2.

** DONE Pallet Configuration:
*** DONE θ coordinate must be numerical.

** TODO Layout Generator:
*** DONE Row Column-Fill (Version 1)

** TODO TeachMode:
*** DONE Compute rotation of pallet relative to box. (may not be relevant anymore.)
*** DONE Jogger Rotation Display.
*** DONE IO/Jog controller safety on use before initialization in subcomponents.
*** TODO Limit Stack Height.
*** DONE Add good pick detection in teach mode.
*** DONE θ coordinate numerical
*** DONE Round coordinates in the jogger.
*** DONE Update jogger to use numberical rotation (UI piece for this as well.)
*** DONE Make stack screen display stack in proper order.
*** DONE Fix stack screen delete bug.
*** DONE (Wait) Clean up configuration format (final box coordinates).
*** DONE Handle box size change -- sort out configurations.

** DONE mm-js-api:
*** DONE Use position from step counts. (Gain computation.) -- This is crucial for not causing giving strang positions when user jogs past end stops.
*** DONE Add m201, m203 commands.

** TODO Production:
*** DONE Logging.
*** TODO Update protocol -- git?

** DONE Jogger:
*** DONE Perspective Jogger
*** DONE Plugin controls.
*** DONE Improve beauty and usability.
*** DONE React memoization issue.
*** DONE Return to discrete rotations.
*** DONE Add a go to taught position.

** DONE Engine:
*** DONE Add Good Pick Detection + Box Detection Actions.
*** DONE Consistent error messaging to client. (see: catch blocks and information send)

** DONE Configuration Page:
*** DONE Reload configs on create (so that they show up immediately).
*** DONE Machine config jogger.
*** DONE Delete Machine Motion.

** TODO Visualizer:
*** DONE Visualizer: Frame + coordinates + axes 
*** DONE Visualizer -- drop locations in order.
*** DONE Visualizer -- partial rotations of pallet + boxe
*** TODO Test multiple pallets.

** DONE Vivian Requests:
*** DONE Add a "go to taught position" button for validation ?? Where should this button go?
*** DONE There should be a pure jogger screen (not needing to go to pallet config or machine config ?? Extra button on machine configuration for jogger?
*** DONE Layer configuration is tough to use (snapping with overlaps). Need better control of the boxes location too
*** DONE There should be labelled "x and y and z" in every image. With proper orientations ?? Going to need good images then.
*** DONE Path optimization needs to be fixed ?? Can I get a real configuration. -- Use optimized standard.
*** DONE There should be a home axes screen in the pallet configuration. Step 3 should not show unless homed first
*** DONE There should be homing buttons in the home page ?? Ah, okay. -- TEST- Jog controller init (release and reset) may not be completed.
*** DONE There should be a system speed and acceleration ?? Will do by drive.boxes properly along rows.
*** DONE Reverse Teach Mode stack direction.

** TODO Database:
*** TODO (dev) make raw_json more editable.

** DONE New List: 
*** DONE When changing the pick location or changing the box size in the pallet configuration, it's not reflected in the rest of the configuration. This occurs when you edit a pre-existing configuration
*** DONE We should test the same thing to edit teach points for pallets (re-teaching after editing an existing config file)
*** DONE Deleting layer pattern does not work
*** DONE When adding layers and deleting layers, it seems to be upside down (weird UI behaviour) ?? Ask.
*** DONE We need to change the clearance height of the pallet because today during the marketing shoot, we ran into interferences at the fourth layer. I think it'll only get worse for even higher layers. Max, i can show you later today!
*** DONE We need to test for reliability, because it keeps running into errors. I know Max and Alex, you're already on this, but I just wanted us to track this in a list. (https://github.com/VentionCo/mm-vention-control/issues/1129)
*** DONE Max and I talked about how we could improve the user experience to not need to create an offset when configuring the teach points of a pallet. So, we suggested placing 3 boxes at each teach point on the pallet. Teach the EOAT to get to those points and depending on the box size, we could determine the size and position of the pallet. Alex, please let me know if this is clear to you or not.
*** DONE The 3D render still has some glitches in terms of box positioning. I can not reliably repro. But the positions seem off for the boxes.
*** DONE We need to make the drag/drop boxes on the "edit" layer more reliable. Easily snap to the edges of each box, so that the positioning is the same each time, eliminating human error and getting more repeatable positioning. If you have a better option to configure it through "edit rows and columns" format, that would be fine too (after defining the orientation of the box).
*** DONE Replace images/renders from britt to update.
*** DONE Take the "Home x, home y, home z, home theta, done" to step 1. Remove your current step 1 with the jogger to replace it with only the homing buttons. Remove the flow of homing first for pick location, teach points before being able to move onto them. Add drop down menu for "add machine configuration" into the "name pallet configuration" step. This is to match up to Matt's path following app too. 
*** DONE Test the input sensor
*** DONE When moving the boxes when configuring a layer: mouse capture is missing also (i.e. if I mousedown, then move the mouse too quickly, I lose the box, and later when I reenter the area, the box stays attached to mousemove).
*** DONE Automated ordering of boxes based on pick location (to accommodate the lateral movement Max has implemented). Currently, it is manually determined.
*** DONE Automated input sensing.
*** DONE Input Splash Screen.
*** DONE Machine Config Styling
*** DONE Don't remove layers + stack if box pick point is the only thing that changed.

** TODO Further Items
*** DONE Sorting boxes by row for lateral approach
*** DONE Mechanics of box drag + drop.
*** DONE Monitoring pick quality over path.
*** TODO Updating mechanism for machine apps.
*** DONE Edit Machine Motion. etc.
*** TODO Make sure that the current configuration selection mechanism is robust -- don't allow starting with incomplete configuration.
*** TODO Show stack display realtime in the Stack.tsx.
*** DONE Fix Jogger Bug.
*** DONE Handle master / slave estop situation.
*** DONE Master Slave issue also has to be solved in the control center button.
*** DONE Add positions to machine jogger.
*** DONE Palletizer won't stop when returning to pick location.
*** DONE Changing pick location does not update inside of layers (where the box is copied). This is stupid -- we should get pick location from box index.
*** DONE In browser IO Monitoring doesn't work.
*** DONE Make sure that all teach screens, after deleting all, disables the next button (see Pallets.tsx (Right button))
*** DONE Box Detection should be moved to Box Size Area (not the main thing.)
*** DONE Box detection and monitoring label the same thing.
*** DONE Make sure that box detection is functional.
*** DONE Heights are a little low on second layer -- fix this.
*** DONE Update visualizer to reflect top of box (And add instructions for this.) (maybe offset).
*** DONE Make sure that stop actually stops.

** TODO Post FAT
*** DONE Add a "go to taught position" button for validation (for teach position of the pallet corners and the pick locations)
*** DONE We need to make the drag/drop boxes on the "edit" layer more reliable. Easily snap to the edges of each box, so that the positioning is the same each time, eliminating human error and getting more repeatable positioning. If you have a better option to configure it through "edit rows and columns" format, that would be fine too (after defining the orientation of the box).
*** TODO There should be labelled "x and y and z" in every image. With proper orientations ?? What is the confusion?
*** DONE Missing software stop in palletizer app
*** DONE Clicking the empty save outside the config screen should not close the configuration screen. Use "x" at top right corner
*** DONE 3D Render height. 
*** DONE The 3D render still has some glitches in terms of box positioning and representation
*** TODO Replace images/renders from britt to update
*** DONE Test the input sensor
*** DONE Input sensor should be configurable for each box (input menu should just have an association for the box created)
*** DONE Wire the master and slave controller
*** DONE Figure what's wrong with the drop distances
*** DONE Automated ordering of boxes based on pick location (there's an issue for some box placements)
*** DONE Ability to palletize separators using a z height difference. Instead of using an infeed conveyors, it would palletize stacks. So in the "configure box" section, there should be a drop down options that include "Palletize from in-feed" or "Palletize from stack". "Palletize from stack" option is removing the height difference of the box for each time it picks that box.
*** DONE Make sure the e-stop will not stop the gripper from functioning
*** DONE Gripper pressure signal - implement check whether box is still on the gripper or no (wiring, logic)
*** TODO IF there is time, update layer image with your visualiser
*** DONE Don't allow jogger on incomplete machine configuration.
*** DONE Tailor height addition for top-of-box teach.

** DONE Actual.
*** DONE Make sure stop works.
*** DONE Single IO Selection.
*** DONE Make sure IO's update on the UI.
*** DONE Make sure that drag mechanics work.
*** DONE Make sure that you can resume after an error (move a box, etc.). -- this is not the case currently. -- Use the start from box metric.
*** DONE Path optimization fix (lateral approach).
*** DONE Stop suction from the main page.
*** DONE Sort out the estop controversy.
*** DONE Monitoring along path.
*** DONE Picking from stack.
*** DONE Manually modifying coordinates.
*** DONE IO by pin (not by module).
*** DONE Toggle suction from jogger / home screen.
*** DONE Make sure that palletizer angle works.
*** DONE Palletizer visualizer is in outer space for some reason -- not sure why.
*** DONE Visualizer needs to be able to handle real coordinates in order. (Send up drop locations in status update?).

** DONE Execute:
*** DONE Toggle suction from home screen.
*** DONE Fix homing on home screen.

** DONE Visualizer: 
*** DONE Fix the box display surrealism.
*** DONE Display in the stack area. (Dynamically add boxes).

** DONE mm-cli
*** DONE Logs
*** DONE Motion Control
*** DONE MQTT Stream
*** DONE Test server

********MAIN********

* TODO Pre Deploy Items 
** DONE Save box bug.
** DONE Delete box bug (box index).
** DONE Estop bug.
** DONE Toggle stuction from jogger / home screen.
** DONE Logging.
** DONE Verify palletizer offset angle.
** DONE Start from box, use non-confusing number.
** DONE Error message handling.
** DONE Retry failed requests.
** DONE Go to taught position in jogger.
** DONE Drag and drop mechanics.
** DONE In browser IO monitoring.
** DONE Home on complete.
** DONE Homing on start from box. (home if zero is a good metric).
** DONE Add in images.
** DONE The +3.5 height issue. (svg_props in Layouts.tsx)
** DONE Add IO light.
** TODO MQTT attempt to reconnect.
** TODO Current configuration mechanism (What happens if there are no configurations).
** TODO Distribution of application.
** TODO CORS.
** TODO Startup script.
** TODO Sever static files.
** DONE Error message for bad pick.

* TODO Future Items (insulfloor)
** TODO Convert to mm-app-engine.
** TODO MM-app engine api.
** TODO Use estop state to monitor for estop release..
** TODO MM-APP-BUILDER
** TODO Log usage on machine motion (all distance travelled).
** TODO Default drives.

** DONE This:
Server (18479): SyntaxError: Unexpected number in JSON at position 1
Server (18479):     at JSON.parse (<anonymous>)
Server (18479):     at MqttClient.<anonymous> (/home/alex/mm-js-api/dist/MessageController.js:132:27)
Server (18479):     at MqttClient.emit (events.js:326:22)
Server (18479):     at MqttClient._handlePublish (/home/alex/mm-js-api/node_modules/mqtt/lib/client.js:1271:12)
Server (18479):     at MqttClient._handlePacket (/home/alex/mm-js-api/node_modules/mqtt/lib/client.js:410:12)
Server (18479):     at work (/home/alex/mm-js-api/node_modules/mqtt/lib/client.js:321:12)
Server (18479):     at Writable.writable._write (/home/alex/mm-js-api/node_modules/mqtt/lib/client.js:335:5)
Server (18479):     at doWrite (/home/alex/mm-js-api/node_modules/readable-stream/lib/_stream_writable.js:428:64)
Server (18479):     at writeOrBuffer (/home/alex/mm-js-api/node_modules/readable-stream/lib/_stream_writable.js:417:5)
Server (18479):     at Writable.write (/home/alex/mm-js-api/node_modules/readable-stream/lib/_stream_writable.js:334:11)
 
** NOTE gCode logs available at: debian@beaglebone:/var/lib/cloud9/vention-control/machineMotion/logs$ tail -f server-2020-09-22-02.log 
** debian@beaglebone:/var/lib/cloud9/vention-control/machineMotion/logs$ tail -f server-2020-09-22-04.log | grep "G[0-9]*\|M92"
** NOW mm -log
